name: Build and Release Windows App

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
  actions: read    # å…è®¸è¯»å– Actions
  checks: read     # å…è®¸è¯»å–æ£€æŸ¥çŠ¶æ€

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate Changelog
      id: changelog
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          current_tag=${{ github.ref_name }}
          prev_tag=$(git describe --tags --abbrev=0 ${current_tag}^ 2>/dev/null || echo "")
          
          if [ -n "$prev_tag" ]; then
            echo "Generating changelog from $prev_tag to $current_tag"
            log=$(git log --pretty=format:"- %s (%h)" ${prev_tag}..${current_tag})
          else
            echo "Generating changelog for initial tag $current_tag"
            log=$(git log --pretty=format:"- %s (%h)" ${current_tag})
          fi
        else
          echo "Generating changelog for manual build (last 10 commits)"
          log=$(git log --pretty=format:"- %s (%h)" -n 10)
        fi
        
        echo "content<<EOF" >> $GITHUB_OUTPUT
        echo "$log" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
    
    - name: Use Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: "pnpm"
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc
    
    - name: Install frontend dependencies
      run: pnpm install
    
    - name: Build Tauri app
      run: pnpm tauri build
      env:
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
    
    # åˆ›å»º Releaseï¼ˆæ”¯æŒæ ‡ç­¾æ¨é€å’Œæ‰‹åŠ¨è§¦å‘ï¼‰
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      with:
        files: |
          src-tauri/target/release/bundle/nsis/*.exe
        generate_release_notes: true
        draft: false
        prerelease: ${{ github.event_name == 'workflow_dispatch' }}
        name: ${{ startsWith(github.ref, 'refs/tags/') && format('Release {0}', github.ref_name) || format('Manual Build {0}', github.run_number) }}
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('manual-build-{0}', github.run_number) }}
        body: |
          ## ğŸš€ ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·
          
          ### ğŸ“¦ ä¸‹è½½
          - **Windows å®‰è£…åŒ…**: `*.exe` æ–‡ä»¶ï¼ˆNSIS å®‰è£…ç¨‹åºï¼‰
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          ${{ steps.changelog.outputs.content }}
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `.exe` æ–‡ä»¶
          2. å³é”®é€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
          3. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸º Artifact
    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer-${{ github.run_number }}
        path: src-tauri/target/release/bundle/nsis/*.exe
        retention-days: 30